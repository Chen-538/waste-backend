<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>環保辨識器</title>
  <meta name="description" content="請拍照或上傳圖片，後端以 OpenAI 分析回傳分類結果（前端不含任何金鑰）。" />
  <style>
    /* ====== Theme ====== */
    :root{
      --bg1:#f0fdf4;  /* green-50 */
      --bg2:#f7fee7;  /* lime-50 */
      --paper:#ffffff;
      --ink:#0f172a;  /* slate-900 */
      --muted:#64748b;/* slate-500 */
      --accent:#16a34a;/* green-600 */
      --accent-2:#22c55e;/* green-500 */
      --danger:#ef4444;/* red-500 */
      --border:#e5e7eb;/* gray-200 */
      --shadow:0 12px 30px rgba(2, 6, 23, .08);
      --ring: 0 0 0 4px rgba(34,197,94,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(132,204,22,.10), transparent 60%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><defs><pattern id="p" width="120" height="120" patternUnits="userSpaceOnUse"><g opacity="0.05"><path d="M60 10c15 25-15 45 0 70c15-25-15-45 0-70Z" fill="%2322c55e"/><circle cx="20" cy="80" r="6" fill="%2316a34a"/><circle cx="100" cy="40" r="5" fill="%2316a34a"/></g></pattern></defs><rect width="120" height="120" fill="url(%23p)"/></svg>'),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
    }
    .container{max-width:980px;margin:0 auto;padding:28px 20px}
    h1{margin:0 0 8px; text-align:center; font-size:32px; letter-spacing:.04em}
    .subtitle{color:var(--muted); text-align:center; margin-bottom:18px}

    /* ====== Cards & layout ====== */
    .card{background:var(--paper); border:1px solid var(--border); border-radius:22px; padding:20px; box-shadow:var(--shadow)}
    .stack{display:flex; flex-direction:column; align-items:center; gap:14px}

    .center{display:flex; justify-content:center}

    .drop{position:relative; width:min(92vw,720px); height:min(58vh,380px); border:2px dashed var(--border); border-radius:20px; display:flex; align-items:center; justify-content:center; background:#fafafa}
    .drop.drag{background:#ecfdf5; border-color:#86efac; box-shadow:var(--ring)}
    .arrow{width:96px; height:96px; opacity:.65}
    .preview{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; border-radius:18px; display:none; background:#fff}

    /* ====== Buttons (glow + ripple) ====== */
    .row{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
    .btn{position:relative; overflow:hidden; isolation:isolate; appearance:none; border:1px solid var(--border); background:var(--accent); color:#fff; padding:12px 18px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:0 6px 14px rgba(22,163,74,.18); transition: transform .12s ease, box-shadow .2s ease}
    .btn:hover{box-shadow:0 0 0 0 rgba(0,0,0,0), 0 0 18px rgba(34,197,94,.55)}
    .btn:active{transform: translateY(1px)}
    .btn.ghost{background:#fff; color:var(--ink)}
    .btn.warn{background:var(--danger)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn .ripple{position:absolute; inset:auto; border-radius:999px; transform:translate(-50%,-50%); pointer-events:none; opacity:.35; background:#fff; animation:ripple .7s ease-out forwards}
    @keyframes ripple{0%{width:0;height:0;opacity:.45}100%{width:420px;height:420px;opacity:0}}

    /* ====== Progress & status ====== */
    .progress{height:10px; background:#eaf6ee; border-radius:999px; overflow:hidden; width:min(92vw,720px)}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition: width .25s ease}
    .small{font-size:12px; color:var(--muted)}

    /* ====== Floating leaves ====== */
    .leaves{position:fixed; inset:0; pointer-events:none; z-index:0}
    .leaf{position:absolute; width:16px; height:16px; background:radial-gradient(circle at 30% 30%, #86efac, #22c55e); border-radius:2px 12px 2px 12px; opacity:.15; transform:rotate(45deg)}
    @keyframes floatY{0%{transform:translateY(0) rotate(45deg)} 100%{transform:translateY(-120vh) rotate(135deg)}}
    @media (prefers-reduced-motion: reduce){ .leaf{display:none} }
  </style>
</head>
<body>
  <!-- 背景落葉 -->
  <div class="leaves" id="leaves"></div>

  <div class="container" style="position:relative; z-index:1">
    <h1 class="center">環保辨識器</h1>
    <div class="subtitle">請拍照或上傳你的圖片（由後端分析）</div>

    <div class="card stack center">
      <div id="drop" class="drop" aria-label="上傳區">
        <!-- ✅ 兩個 input：相簿(無 capture) + 相機(有 capture) -->
        <input id="fileGallery" type="file" accept="image/*" style="display:none" />
        <input id="fileCamera"  type="file" accept="image/*" capture="environment" style="display:none" />

        <!-- Arrow icon -->
        <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 19V6"/><path d="m5 13 7-7 7 7"/></svg>
        <img id="preview" class="preview" alt="預覽" />
      </div>

      <div class="row">
        <button id="btnGallery" class="btn ghost" type="button">相簿</button>
        <button id="btnCamera"  class="btn ghost" type="button">拍照</button>
        <button id="clear" class="btn warn" type="button">刪除</button>
        <button id="run" class="btn" disabled>辨識</button>
      </div>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="status" class="small">等待上傳圖片…</div>
    </div>

    <div class="card" style="margin-top:16px">
      <div id="resultLine" class="center" style="font-size:18px">輸出：<span class="small">尚未辨識</span></div>
    </div>
  </div>

<script>
  // ====== 後端 API ======
  const API_URL = "https://waste-backend-61ec.onrender.com/api/classify"; // ← 換成你的

  // ====== 背景落葉 ======
  const leaves = document.getElementById('leaves');
  for(let i=0;i<16;i++){
    const el = document.createElement('div'); el.className='leaf';
    const left = Math.random()*100; const delay = Math.random()*12; const dur = 16 + Math.random()*12; const size = 12+Math.random()*14;
    el.style.left = left+'%'; el.style.bottom='-40px'; el.style.width=size+'px'; el.style.height=size+'px';
    el.style.animation = `floatY ${dur}s linear ${delay}s infinite`;
    leaves.appendChild(el);
  }

  // ====== Utils ======
  const els = {
    fileGallery: document.getElementById('fileGallery'),
    fileCamera:  document.getElementById('fileCamera'),
    btnGallery:  document.getElementById('btnGallery'),
    btnCamera:   document.getElementById('btnCamera'),
    clear:       document.getElementById('clear'),
    drop:        document.getElementById('drop'),
    preview:     document.getElementById('preview'),
    run:         document.getElementById('run'),
    status:      document.getElementById('status'),
    bar:         document.getElementById('bar'),
    resultLine:  document.getElementById('resultLine'),
  };

  function setProgress(p){ els.bar.style.width = `${Math.max(0, Math.min(100, p))}%`; }
  function showPreview(url){ els.preview.src = url; els.preview.style.display = 'block'; }
  function clearPreview(){
    els.preview.src = ''; els.preview.style.display = 'none';
    els.run.disabled = true;
    els.resultLine.innerHTML = '輸出：<span class="small">尚未辨識</span>';
  }
  function ripple(e){
    const x=e.offsetX, y=e.offsetY; const s=document.createElement('span');
    s.className='ripple'; s.style.left=x+'px'; s.style.top=y+'px';
    e.currentTarget.appendChild(s); setTimeout(()=>s.remove(), 800);
  }

  // 讀檔並壓縮成 DataURL
  function compressImage(file, maxSide = 1280, quality = 0.85) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          if (!blob) return reject(new Error('toBlob failed'));
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result); // DataURL
          fr.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  let currentDataURL = null;

  async function setPreviewFromFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    showPreview(url);
    // 壓縮存成 DataURL，再送去後端
    currentDataURL = await compressImage(file, 1280, 0.85);
    els.run.disabled = false;
    els.status.textContent='圖片就緒，按「辨識」';
  }

  // ====== 按鈕/輸入事件 ======
  els.btnGallery.addEventListener('click', (e)=>{ ripple(e); els.fileGallery.click(); });
  els.btnCamera.addEventListener('click',  (e)=>{ ripple(e); els.fileCamera.click();  });
  els.clear.addEventListener('click',     (e)=>{ ripple(e); currentDataURL=null; clearPreview(); els.status.textContent='已清除圖片'; });

  els.fileGallery.addEventListener('change', (e)=> setPreviewFromFile(e.target.files[0]));
  els.fileCamera .addEventListener('change', (e)=> setPreviewFromFile(e.target.files[0]));

  // Drag & Drop
  ['dragenter','dragover'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.remove('drag'); }));
  els.drop.addEventListener('drop', (e)=>{ const f=e.dataTransfer.files?.[0]; if(f) setPreviewFromFile(f); });

  // 顯示結果：≥75% 不顯示機率
  function setResult(name, score){
    const p = Math.round((score||0)*100);
    if (score >= 0.75) {
      els.resultLine.innerHTML = `輸出：就是（<b>${name||'未知'}</b>）`;
    } else if (score >= 0.45) {
      els.resultLine.innerHTML = `輸出：較可能（${p}%）是（<b>${name||'未知'}</b>）`;
    } else {
      els.resultLine.innerHTML = `輸出：<span class="small">不確定（最高 ${p}%）</span>`;
    }
  }
  function setUncertain(msg){ els.resultLine.innerHTML = `輸出：<span class="small">${msg}</span>`; }

  // ====== 呼叫後端 ======
  els.run.addEventListener('click', async (e)=>{
    ripple(e);
    try{
      if(!currentDataURL) return setUncertain('尚未選擇圖片');
      setProgress(15); els.status.textContent='上傳中…';

      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ image: currentDataURL })
      });
      if(!resp.ok){ const t = await resp.text(); throw new Error('後端錯誤：'+resp.status+' '+t); }

      els.status.textContent='分析中…'; setProgress(60);
      const data = await resp.json();
      const top = data.top || data; // {top:{name,score}} 或直接 {name,score}
      setResult(top.name, top.score);

      els.status.textContent='完成'; setTimeout(()=> setProgress(0), 900);
    }catch(err){
      console.error(err);
      setUncertain(err.message||'推論發生錯誤'); els.status.textContent='失敗'; setProgress(0);
    }
  });
</script>
</body>
</html>
