<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç’°ä¿è¾¨è­˜å™¨</title>
  <meta name="description" content="è«‹æ‹ç…§æˆ–ä¸Šå‚³åœ–ç‰‡ï¼Œå¾Œç«¯ä»¥ OpenAI åˆ†æå›å‚³åˆ†é¡çµæœï¼ˆå‰ç«¯ä¸å«ä»»ä½•é‡‘é‘°ï¼‰ã€‚" />
  <style>
    /* ç•¥ï¼šä¿ç•™ä½ åŸæœ¬çš„æ¨£å¼å³å¯ */
    /* ... é€™è£¡çœç•¥ï¼ˆä½ çš„ CSS åŸå°ä¸å‹•ä¿ç•™ï¼‰ ... */
  </style>
</head>
<body>
  <div class="leaves" id="leaves"></div>

  <div class="container" style="position:relative; z-index:1">
    <h1 class="center">ç’°ä¿è¾¨è­˜å™¨</h1>
    <div class="subtitle">è«‹æ‹ç…§æˆ–ä¸Šå‚³ä½ çš„åœ–ç‰‡ï¼ˆç”±å¾Œç«¯åˆ†æï¼‰</div>

    <div class="card stack center">
      <div id="drop" class="drop" aria-label="ä¸Šå‚³å€">
        <!-- âœ… å…©å€‹ inputï¼šç›¸ç°¿(ç„¡ capture) + ç›¸æ©Ÿ(æœ‰ capture) -->
        <input id="fileGallery" type="file" accept="image/*" style="display:none" />
        <input id="fileCamera"  type="file" accept="image/*" capture="environment" style="display:none" />

        <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 19V6"/><path d="m5 13 7-7 7 7"/></svg>
        <img id="preview" class="preview" alt="é è¦½" />
      </div>

      <div class="row">
        <!-- âœ… åˆ†æˆå…©é¡†æŒ‰éˆ• -->
        <button id="btnGallery" class="btn ghost" type="button">ç›¸ç°¿</button>
        <button id="btnCamera"  class="btn ghost" type="button">æ‹ç…§</button>
        <button id="clear" class="btn warn" type="button">åˆªé™¤</button>
        <button id="run" class="btn" disabled>è¾¨è­˜</button>
      </div>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="status" class="small">ç­‰å¾…ä¸Šå‚³åœ–ç‰‡â€¦</div>
    </div>

    <div class="card" style="margin-top:16px">
      <div id="resultLine" class="center" style="font-size:18px">è¼¸å‡ºï¼š<span class="small">å°šæœªè¾¨è­˜</span></div>
    </div>
  </div>

<script>
  // ====== å¾Œç«¯ API ======
  const API_URL = "https://waste-backend-61ec.onrender.com/api/classify"; // â† æ›æˆä½ çš„

  // ====== èƒŒæ™¯è½è‘‰ï¼ˆä¿ç•™ä½ åŸæœ¬çš„ï¼‰ ======
  const leaves = document.getElementById('leaves');
  for(let i=0;i<16;i++){
    const el = document.createElement('div'); el.className='leaf';
    const left = Math.random()*100; const delay = Math.random()*12; const dur = 16 + Math.random()*12; const size = 12+Math.random()*14;
    el.style.left = left+'%'; el.style.bottom='-40px'; el.style.width=size+'px'; el.style.height=size+'px';
    el.style.animation = `floatY ${dur}s linear ${delay}s infinite`;
    leaves.appendChild(el);
  }

  // ====== Utils ======
  const els = {
    fileGallery: document.getElementById('fileGallery'),
    fileCamera:  document.getElementById('fileCamera'),
    btnGallery:  document.getElementById('btnGallery'),
    btnCamera:   document.getElementById('btnCamera'),
    clear:       document.getElementById('clear'),
    drop:        document.getElementById('drop'),
    preview:     document.getElementById('preview'),
    run:         document.getElementById('run'),
    status:      document.getElementById('status'),
    bar:         document.getElementById('bar'),
    resultLine:  document.getElementById('resultLine'),
  };

  function setProgress(p){ els.bar.style.width = `${Math.max(0, Math.min(100, p))}%`; }
  function showPreview(url){ els.preview.src = url; els.preview.style.display = 'block'; }
  function clearPreview(){
    els.preview.src = ''; els.preview.style.display = 'none';
    els.run.disabled = true;
    els.resultLine.innerHTML = 'è¼¸å‡ºï¼š<span class="small">å°šæœªè¾¨è­˜</span>';
  }
  function ripple(e){
    const x=e.offsetX, y=e.offsetY; const s=document.createElement('span');
    s.className='ripple'; s.style.left=x+'px'; s.style.top=y+'px';
    e.currentTarget.appendChild(s); setTimeout(()=>s.remove(), 800);
  }

  // ğŸ”§ è®€æª”ä¸¦å£“ç¸®æˆ DataURLï¼ˆé¿å…åŸåœ–å¤ªå¤§ï¼‰
  function compressImage(file, maxSide = 1280, quality = 0.85) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          if (!blob) return reject(new Error('toBlob failed'));
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result); // DataURL
          fr.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  let currentDataURL = null;

  async function setPreviewFromFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    showPreview(url);
    // å£“ç¸®å­˜æˆ DataURLï¼Œç­‰ç­‰ç›´æ¥é€å‡ºå»
    currentDataURL = await compressImage(file, 1280, 0.85);
    els.run.disabled = false;
    els.status.textContent='åœ–ç‰‡å°±ç·’ï¼ŒæŒ‰ã€Œè¾¨è­˜ã€';
  }

  // ====== æŒ‰éˆ•/è¼¸å…¥äº‹ä»¶ ======
  els.btnGallery.addEventListener('click', (e)=>{ ripple(e); els.fileGallery.click(); });
  els.btnCamera.addEventListener('click',  (e)=>{ ripple(e); els.fileCamera.click();  });
  els.clear.addEventListener('click',     (e)=>{ ripple(e); currentDataURL=null; clearPreview(); els.status.textContent='å·²æ¸…é™¤åœ–ç‰‡'; });

  els.fileGallery.addEventListener('change', (e)=> setPreviewFromFile(e.target.files[0]));
  els.fileCamera .addEventListener('change', (e)=> setPreviewFromFile(e.target.files[0]));

  // Drag & Drop ç…§èˆŠ
  ['dragenter','dragover'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.remove('drag'); }));
  els.drop.addEventListener('drop', (e)=>{ const f=e.dataTransfer.files?.[0]; if(f) setPreviewFromFile(f); });

  // é¡¯ç¤ºçµæœï¼šâ‰¥75% ä¸é¡¯ç¤ºæ©Ÿç‡
  function setResult(name, score){
    const p = Math.round((score||0)*100);
    if (score >= 0.75) {
      els.resultLine.innerHTML = `è¼¸å‡ºï¼šå°±æ˜¯ï¼ˆ<b>${name||'æœªçŸ¥'}</b>ï¼‰`;
    } else if (score >= 0.45) {
      els.resultLine.innerHTML = `è¼¸å‡ºï¼šè¼ƒå¯èƒ½ï¼ˆ${p}%ï¼‰æ˜¯ï¼ˆ<b>${name||'æœªçŸ¥'}</b>ï¼‰`;
    } else {
      els.resultLine.innerHTML = `è¼¸å‡ºï¼š<span class="small">ä¸ç¢ºå®šï¼ˆæœ€é«˜ ${p}%ï¼‰</span>`;
    }
  }
  function setUncertain(msg){ els.resultLine.innerHTML = `è¼¸å‡ºï¼š<span class="small">${msg}</span>`; }

  // ====== å‘¼å«å¾Œç«¯ ======
  els.run.addEventListener('click', async (e)=>{
    ripple(e);
    try{
      if(!currentDataURL) return setUncertain('å°šæœªé¸æ“‡åœ–ç‰‡');
      setProgress(15); els.status.textContent='ä¸Šå‚³ä¸­â€¦';

      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ image: currentDataURL })
      });
      if(!resp.ok){ const t = await resp.text(); throw new Error('å¾Œç«¯éŒ¯èª¤ï¼š'+resp.status+' '+t); }

      els.status.textContent='åˆ†æä¸­â€¦'; setProgress(60);
      const data = await resp.json();
      const top = data.top || data; // {top:{name,score}} æˆ–ç›´æ¥ {name,score}
      setResult(top.name, top.score);

      els.status.textContent='å®Œæˆ'; setTimeout(()=> setProgress(0), 900);
    }catch(err){
      console.error(err);
      setUncertain(err.message||'æ¨è«–ç™¼ç”ŸéŒ¯èª¤'); els.status.textContent='å¤±æ•—'; setProgress(0);
    }
  });
</script>
</body>
</html>
