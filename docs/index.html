<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>蔬菜辨識器</title>
  <meta name="description" content="拍照或上傳蔬菜的照片，幫你辨識是哪一種蔬菜（高麗菜、青江菜、番茄、馬鈴薯…）。" />
  <style>
    :root{
      --bg1:#f0fdf4; --bg2:#f7fee7; --paper:#ffffff; --ink:#0f172a; --muted:#64748b;
      --accent:#16a34a; --accent-2:#22c55e; --danger:#ef4444; --border:#e5e7eb;
      --shadow:0 12px 30px rgba(2, 6, 23, .08); --ring:0 0 0 4px rgba(34,197,94,.25);
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{
      font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(132,204,22,.10), transparent 60%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><defs><pattern id="p" width="120" height="120" patternUnits="userSpaceOnUse"><g opacity="0.05"><path d="M60 10c15 25-15 45 0 70c15-25-15-45 0-70Z" fill="%2322c55e"/><circle cx="20" cy="80" r="6" fill="%2316a34a"/><circle cx="100" cy="40" r="5" fill="%2316a34a"/></g></pattern></defs><rect width="120" height="120" fill="url(%23p)"/></svg>'),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
    }
    .container{max-width:980px;margin:0 auto;padding:28px 20px}
    h1{margin:0 0 8px; text-align:center; font-size:32px; letter-spacing:.04em}
    .subtitle{color:var(--muted); text-align:center; margin-bottom:18px}
    .card{background:var(--paper); border:1px solid var(--border); border-radius:22px; padding:20px; box-shadow:var(--shadow)}
    .stack{display:flex; flex-direction:column; align-items:center; gap:14px}
    .center{display:flex; justify-content:center}
    .drop{position:relative; width:min(92vw,720px); height:min(58vh,380px); border:2px dashed var(--border); border-radius:20px; display:flex; align-items:center; justify-content:center; background:#fafafa}
    .drop.drag{background:#ecfdf5; border-color:#86efac; box-shadow:var(--ring)}
    .arrow{width:96px; height:96px; opacity:.65}
    .preview{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; border-radius:18px; display:none; background:#fff}
    .row{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
    .btn{position:relative; overflow:hidden; isolation:isolate; appearance:none; border:1px solid var(--border); background:var(--accent); color:#fff; padding:12px 18px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:0 6px 14px rgba(22,163,74,.18); transition: transform .12s ease, box-shadow .2s ease}
    .btn:hover{box-shadow:0 0 0 0 rgba(0,0,0,0), 0 0 18px rgba(34,197,94,.55)}
    .btn:active{transform: translateY(1px)}
    .btn.ghost{background:#fff; color:var(--ink)}
    .btn.warn{background:var(--danger)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn .ripple{position:absolute; inset:auto; border-radius:999px; transform:translate(-50%,-50%); pointer-events:none; opacity:.35; background:#fff; animation:ripple .7s ease-out forwards}
    @keyframes ripple{0%{width:0;height:0;opacity:.45}100%{width:420px;height:420px;opacity:0}}
    .progress{height:10px; background:#eaf6ee; border-radius:999px; overflow:hidden; width:min(92vw,720px)}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition: width .25s ease}
    .small{font-size:12px; color:var(--muted)}
    .leaves{position:fixed; inset:0; pointer-events:none; z-index:0}
    .leaf{position:absolute; width:16px; height:16px; background:radial-gradient(circle at 30% 30%, #86efac, #22c55e); border-radius:2px 12px 2px 12px; opacity:.15; transform:rotate(45deg)}
    @keyframes floatY{0%{transform:translateY(0) rotate(45deg)} 100%{transform:translateY(-120vh) rotate(135deg)}}
    @media (prefers-reduced-motion: reduce){ .leaf{display:none} }
    .meta{margin-top:8px; text-align:center; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="leaves" id="leaves"></div>

  <div class="container" style="position:relative; z-index:1">
    <h1 class="center">蔬菜辨識器</h1>
    <div class="subtitle">請拍照或上傳蔬菜的照片（光線充足、背景簡單，效果更好）</div>

    <div class="card stack center">
      <div id="drop" class="drop" aria-label="上傳區">
        <input id="fileGallery" type="file" accept="image/*" style="display:none" />
        <input id="fileCamera"  type="file" accept="image/*" capture="environment" style="display:none" />
        <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 19V6"/><path d="m5 13 7-7 7 7"/></svg>
        <img id="preview" class="preview" alt="預覽" />
      </div>

      <div class="row">
        <button id="btnGallery" class="btn ghost" type="button">相簿</button>
        <button id="btnCamera"  class="btn ghost" type="button">拍照</button>
        <button id="clear" class="btn warn" type="button">清除</button>
        <button id="run" class="btn" disabled>辨識蔬菜</button>
      </div>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="status" class="small">等待上傳蔬菜照片…</div>
      <div id="meta" class="meta">後端：<span id="backendUrl">—</span>｜模式：<span id="modeLabel">veg</span></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div id="resultLine" class="center" style="font-size:18px">輸出：<span class="small">尚未辨識</span></div>
    </div>
  </div>

<script>
  // ===== 後端 API（固定蔬菜路由，避免混線）
  const API_URL = "https://waste-backend-61ec.onrender.com/api/classify-veg";
  document.getElementById('backendUrl').textContent = API_URL;

  // ===== 背景落葉 =====
  const leaves = document.getElementById('leaves');
  for(let i=0;i<16;i++){
    const el = document.createElement('div'); el.className='leaf';
    const left = Math.random()*100; const delay = Math.random()*12; const dur = 16 + Math.random()*12; const size = 12+Math.random()*14;
    el.style.left = left+'%'; el.style.bottom='-40px'; el.style.width=size+'px'; el.style.height=size+'px';
    el.style.animation = `floatY ${dur}s linear ${delay}s infinite`;
    leaves.appendChild(el);
  }

  // ===== Utils =====
  const els = {
    fileGallery: document.getElementById('fileGallery'),
    fileCamera:  document.getElementById('fileCamera'),
    btnGallery:  document.getElementById('btnGallery'),
    btnCamera:   document.getElementById('btnCamera'),
    clear:       document.getElementById('clear'),
    drop:        document.getElementById('drop'),
    preview:     document.getElementById('preview'),
    run:         document.getElementById('run'),
    status:      document.getElementById('status'),
    bar:         document.getElementById('bar'),
    resultLine:  document.getElementById('resultLine'),
    modeLabel:   document.getElementById('modeLabel'),
  };

  function setProgress(p){ els.bar.style.width = `${Math.max(0, Math.min(100, p))}%`; }
  function showPreview(url){ els.preview.src = url; els.preview.style.display = 'block'; }
  function clearPreview(){
    els.preview.src = ''; els.preview.style.display = 'none';
    els.run.disabled = true;
    els.resultLine.innerHTML = '輸出：<span class="small">尚未辨識</span>';
  }
  function ripple(e){
    const x=e.offsetX, y=e.offsetY; const s=document.createElement('span');
    s.className='ripple'; s.style.left=x+'px'; s.style.top=y+'px';
    e.currentTarget.appendChild(s); setTimeout(()=>s.remove(), 800);
  }

  // 圖片壓縮
  function compressImage(file, maxSide = 1280, quality = 0.85) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          if (!blob) return reject(new Error('toBlob failed'));
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  let currentDataURL = null;

  async function setPreviewFromFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    showPreview(url);
    currentDataURL = await compressImage(file, 1280, 0.85);
    els.run.disabled = false;
    els.status.textContent='圖片就緒，按「辨識蔬菜」';
  }

  els.btnGallery.addEventListener('click', (e)=>{ ripple(e); els.fileGallery.click(); });
  els.btnCamera.addEventListener('click',  (e)=>{ ripple(e); els.fileCamera.click();  });
  els.clear.addEventListener('click',     (e)=>{ ripple(e); currentDataURL=null; clearPreview(); els.status.textContent='已清除圖片'; });

  els.fileGallery.addEventListener('change', (e)=> setPreviewFromFile(e.target.files[0]));
  els.fileCamera .addEventListener('change', (e)=> setPreviewFromFile(e.target.files[0]));

  ['dragenter','dragover'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.remove('drag'); }));
  els.drop.addEventListener('drop', (e)=>{ const f=e.dataTransfer.files?.[0]; if(f) setPreviewFromFile(f); });

  // ===== 前端白名單（預設一份，並於啟動時自動向後端同步最新清單） =====
  let VEG_NAMES = [
    "高麗菜","大白菜","青江菜","小白菜/油菜","芥藍","芥菜","雪裡紅","塌棵菜","油麥菜/A菜","結球萵苣/美生菜",
    "奶油萵苣","紫萵苣","蘿蔓","苦苣","菊苣","芝麻葉","水菜","茼蒿","紫甘藍","抱子甘藍",
    "菠菜","紅鳳菜","皇宮菜/胭脂菜","空心菜/蕹菜","地瓜葉","甜菜葉","羽衣甘藍","黑葉羽衣甘藍","羅馬花椰菜","芥菜頭/大頭菜",
    "萵筍/莴笋","豆苗/豌豆苗","苜蓿芽","向日葵芽","蘿蔔苗","西蘭花苗","馬齒莧/長命菜","水芹/野芹","西洋菜/豆瓣菜","香椿芽",
    "紅蘿蔔","白蘿蔔","青蘿蔔","紫長蘿蔔","紅心蘿蔔/西瓜蘿蔔","黑蘿蔔","甜菜根","歐防風","蕪菁/蔓菁","蕪菁葉",
    "蓮藕","藕帶","牛蒡","芋頭","小芋/芋艿","山藥/淮山","菊芋/洋薑","荸薺/馬蹄","芋梗","芹菜根/塊根芹",
    "茴香球莖","薑","蒜頭","薑黃根","山葵根","牛蒡葉","甜菜根葉","紫地瓜","黃地瓜","新馬鈴薯",
    "洋蔥","紫洋蔥","青蔥","大蔥/韭蔥","紅蔥頭/青蔥頭","蒜苗","蒜薹","香葱","藠頭/蕎頭","韭菜",
    "韭黃","韭菜花","韭菜苔","分蔥","洋蔥苗","指狀馬鈴薯","紫皮馬鈴薯","小洋蔥/珠蔥","青蒜","蔥白",
    "小黃瓜/胡瓜","日本小黃瓜","蛇瓜","佛手瓜/合掌瓜","龍鬚菜","蒲瓜/瓠瓜","節瓜/毛瓜","冬瓜","絲瓜","南瓜",
    "栗子南瓜","橡實南瓜","胡桃南瓜","金絲瓜","櫛瓜","黃西葫蘆","金針菜","秋葵","苦瓜","白玉苦瓜",
    "南瓜花","西瓜嫩葉","合掌瓜嫩梢","水蓮","豆薯/涼薯","朝鮮薊","茭白筍/菰筍","玉米","玉米筍","竹筍",
    "綠竹筍","麻竹筍","冬筍","春筍","蘆筍","綠蘆筍","白蘆筍","紫蘆筍",
    "番茄","小番茄/聖女番茄","牛番茄","羅馬番茄","彩虹番茄混合","茄子","日本長茄","圓茄","白茄","青椒/甜椒/彩椒",
    "紅甜椒","黃甜椒","綠甜椒","橙甜椒","辣椒","朝天椒","小米椒","青龍椒","墨西哥辣椒/哈拉佩紐","牛角椒/羊角椒",
    "甜椒粉椒","虎皮青椒","黃燈籠椒","卡宴辣椒","甜香蕉椒","匈牙利黃辣椒","哈瓦那辣椒","阿納罕椒","普布拉諾椒",
    "四季豆","菜豆","長豆/豇豆","扁豆","刀豆","皇帝豆/利馬豆","蠶豆","毛豆/枝豆","黑豆嫩莢","豌豆/荷蘭豆",
    "雪豆","甜豆/翠玉豆","綠豆芽","黃豆芽","黑豆芽","豌豆尖","菜心","芥藍花","油菜苔","龍鬚菜梗",
    "九層塔","甜羅勒","紫蘇/赤紫蘇","迷迭香","百里香","鼠尾草","牛至","蒔蘿","茴香葉","香茅",
    "洋菇","褐蘑菇/克里米尼","口蘑/波特菇","香菇","杏鮑菇","秀珍菇/平菇","金針菇","鴻禧菇","雪白菇","木耳",
    "銀耳/雪耳","舞菇","牛肝菌","珊瑚菇","馬蘭頭","過貓","山蘇","冰花/冰菜","大陸妹",
    "其他蔬菜／待擴充","非蔬菜／不確定"
  ];

  // 啟動時動態同步白名單（若失敗則用預設）
  (async ()=>{
    try{
      const r = await fetch("https://waste-backend-61ec.onrender.com/api/debug-categories?mode=veg", { cache:"no-store" });
      if (r.ok){
        const d = await r.json();
        if (Array.isArray(d.names) && d.names.length) VEG_NAMES = d.names;
      }
    }catch(e){ /* 忽略，使用預設白名單 */ }
  })();

  function sanitizeTop(top){
    // 防止舊垃圾標籤混入：不在白名單 → 改為「非蔬菜／不確定」（保留 raw_guess 不變）
    if (!top || !VEG_NAMES.includes(top.name)) {
      return { name:"非蔬菜／不確定", score:0, raw_guess: top?.raw_guess };
    }
    return top;
  }

  // 顯示結果（支援 raw_guess）
  function setResult(name, score, rawGuess){
    const p = Math.round((score||0)*100);
    const tip = (name === "其他蔬菜／待擴充" && rawGuess) ? `（可能是：<b>${rawGuess}</b>）` : "";
    if (score >= 0.75) {
      els.resultLine.innerHTML = `輸出：就是（<b>${name||'未知'}</b>）${tip}`;
    } else if (score >= 0.45) {
      els.resultLine.innerHTML = `輸出：較可能（${p}%）是（<b>${name||'未知'}</b>）${tip}`;
    } else {
      els.resultLine.innerHTML = `輸出：<span class="small">不確定（最高 ${p}%）</span> ${tip}`;
    }
  }
  function setUncertain(msg){ els.resultLine.innerHTML = `輸出：<span class="small">${msg}</span>`; }

  // 呼叫後端
  els.run.addEventListener('click', async (e)=>{
    ripple(e);
    try{
      if(!currentDataURL) return setUncertain('尚未選擇圖片');
      setProgress(15); els.status.textContent='上傳中…';

      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ image: currentDataURL })
      });
      if(!resp.ok){ const t = await resp.text(); throw new Error('後端錯誤：'+resp.status+' '+t); }

      els.status.textContent='分析中…'; setProgress(60);
      const data = await resp.json();
      if (data?.mode) els.modeLabel.textContent = data.mode;

      // 後端已做白名單；前端再做一次保底，避免任何混線
      const top = sanitizeTop(data.top || data);
      setResult(top.name, top.score, top.raw_guess);

      els.status.textContent='完成'; setTimeout(()=> setProgress(0), 900);
    }catch(err){
      console.error(err);
      setUncertain(err.message||'推論發生錯誤'); els.status.textContent='失敗'; setProgress(0);
    }
  });
</script>
</body>
</html>
