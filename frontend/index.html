<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>環保辨識器</title>
  <meta name="description" content="請拍照或上傳圖片，後端以 OpenAI 分析回傳分類結果（前端不含任何金鑰）。" />
  <style>
    :root{
      --bg1:#f0fdf4; --bg2:#f7fee7; --paper:#ffffff; --ink:#0f172a;
      --muted:#64748b; --accent:#16a34a; --accent-2:#22c55e; --danger:#ef4444;
      --border:#e5e7eb; --shadow:0 12px 30px rgba(2,6,23,.08); --ring:0 0 0 4px rgba(34,197,94,.25);
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{
      font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(132,204,22,.10), transparent 60%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><defs><pattern id="p" width="120" height="120" patternUnits="userSpaceOnUse"><g opacity="0.05"><path d="M60 10c15 25-15 45 0 70c15-25-15-45 0-70Z" fill="%2322c55e"/><circle cx="20" cy="80" r="6" fill="%2316a34a"/><circle cx="100" cy="40" r="5" fill="%2316a34a"/></g></pattern></defs><rect width="120" height="120" fill="url(%23p)"/></svg>'),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
    }
    .container{max-width:980px;margin:0 auto;padding:28px 20px;position:relative;z-index:1}
    h1{margin:0 0 8px;text-align:center;font-size:32px;letter-spacing:.04em}
    .subtitle{color:var(--muted);text-align:center;margin-bottom:18px}
    .card{background:var(--paper);border:1px solid var(--border);border-radius:22px;padding:20px;box-shadow:var(--shadow)}
    .stack{display:flex;flex-direction:column;align-items:center;gap:14px}
    .drop{position:relative;width:min(92vw,720px);height:min(58vh,380px);border:2px dashed var(--border);border-radius:20px;display:flex;align-items:center;justify-content:center;background:#fafafa}
    .drop.drag{background:#ecfdf5;border-color:#86efac;box-shadow:var(--ring)}
    .arrow{width:96px;height:96px;opacity:.65}
    .preview{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;border-radius:18px;display:none;background:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .btn{position:relative;overflow:hidden;isolation:isolate;appearance:none;border:1px solid var(--border);background:var(--accent);color:#fff;padding:12px 18px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(22,163,74,.18);transition:transform .12s ease, box-shadow .2s ease}
    .btn:hover{box-shadow:0 0 0 0 rgba(0,0,0,0), 0 0 18px rgba(34,197,94,.55)}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:#fff;color:var(--ink)}
    .btn.warn{background:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn .ripple{position:absolute;border-radius:999px;transform:translate(-50%,-50%);pointer-events:none;opacity:.35;background:#fff;animation:ripple .7s ease-out forwards}
    @keyframes ripple{0%{width:0;height:0;opacity:.45}100%{width:420px;height:420px;opacity:0}}
    .progress{height:10px;background:#eaf6ee;border-radius:999px;overflow:hidden;width:min(92vw,720px)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .25s ease}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="center">環保辨識器</h1>
    <div class="subtitle">請拍照或上傳你的圖片（由後端分析）</div>

    <div class="card stack">
      <div id="drop" class="drop" aria-label="上傳區">
        <input id="file" type="file" accept="image/*" capture="environment" style="display:none" />
        <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 19V6"/><path d="m5 13 7-7 7 7"/></svg>
        <img id="preview" class="preview" alt="預覽" />
      </div>
      <div class="row">
        <button id="pick" class="btn ghost" type="button">選擇 / 拍照</button>
        <button id="clear" class="btn warn" type="button">刪除</button>
        <button id="run" class="btn" disabled>辨識</button>
      </div>
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="status" class="small">等待上傳圖片…</div>
    </div>

    <div class="card" style="margin-top:16px">
      <div id="resultLine" class="center" style="font-size:18px">輸出：<span class="small">尚未辨識</span></div>
    </div>
  </div>

<script>
  // ← 把這裡改成你的後端 URL（部署到 GitHub Pages 必須是完整 URL）
  // 例如： const API_URL = "https://your-app.onrender.com/api/classify";
  const API_URL = "https://YOUR-BACKEND-URL/api/classify";

  const els = {
    file: document.getElementById('file'),
    pick: document.getElementById('pick'),
    clear: document.getElementById('clear'),
    drop: document.getElementById('drop'),
    preview: document.getElementById('preview'),
    run: document.getElementById('run'),
    status: document.getElementById('status'),
    bar: document.getElementById('bar'),
    resultLine: document.getElementById('resultLine')
  };

  function setProgress(p){ els.bar.style.width = `${Math.max(0, Math.min(100, p))}%`; }
  function showPreview(url){ els.preview.src = url; els.preview.style.display = 'block'; }
  function clearPreview(){ els.preview.src = ''; els.preview.style.display = 'none'; els.run.disabled = true; els.resultLine.innerHTML = '輸出：<span class="small">尚未辨識</span>'; }
  function ripple(e){ const x=e.offsetX, y=e.offsetY; const s=document.createElement('span'); s.className='ripple'; s.style.left=x+'px'; s.style.top=y+'px'; e.currentTarget.appendChild(s); setTimeout(()=>s.remove(), 800); }
  function toDataURL(imgEl){ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); c.width=imgEl.naturalWidth||imgEl.width; c.height=imgEl.naturalHeight||imgEl.height; ctx.drawImage(imgEl,0,0); return c.toDataURL('image/jpeg',0.92); }

  let currentImage=null;
  function setPreview(file){ if(!file) return; const url=URL.createObjectURL(file); showPreview(url); currentImage=url; els.run.disabled=false; els.status.textContent='圖片就緒，按「辨識」'; }
  els.pick.addEventListener('click', (e)=>{ ripple(e); els.file.click(); });
  els.clear.addEventListener('click', (e)=>{ ripple(e); currentImage=null; clearPreview(); els.status.textContent='已清除圖片'; });
  els.file.addEventListener('change', (e)=> setPreview(e.target.files[0]));
  ['dragenter','dragover'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(evt=> els.drop.addEventListener(evt, (e)=>{ e.preventDefault(); els.drop.classList.remove('drag'); }));
  els.drop.addEventListener('drop', (e)=>{ const f=e.dataTransfer.files?.[0]; if(f) setPreview(f); });

  // 以後端決策 message 為主；缺省時退回舊寫法
  function renderUsingBackend(payload){
    if (payload && payload.message){
      els.resultLine.innerHTML = `輸出：${payload.message.replace(/</g,'&lt;')}`;
      return true;
    }
    return false;
  }

  function renderFallback(top){
    const score = Number(top?.score || 0);
    const pct   = Math.round(score * 100);
    const name  = top?.name || '未知';
    if (score >= 0.75) {
      els.resultLine.innerHTML = `輸出：就是（<b>${name}</b>）`;
    } else if (score >= 0.45) {
      els.resultLine.innerHTML = `輸出：較可能（${pct}%）是（<b>${name}</b>）`;
    } else {
      els.resultLine.innerHTML = `輸出：<span class="small">不確定（最高 ${pct}%）</span>`;
    }
  }

  els.run.addEventListener('click', async (e)=>{
    ripple(e);
    try{
      if(!currentImage) return els.resultLine.innerHTML = '輸出：<span class="small">尚未選擇圖片</span>';
      setProgress(15); els.status.textContent='上傳中…';
      const image = toDataURL(els.preview);
      const resp = await fetch(API_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ image }) });
      if(!resp.ok){ const t = await resp.text(); throw new Error('後端錯誤：'+resp.status+' '+t); }
      els.status.textContent='分析中…'; setProgress(60);
      const data = await resp.json();
      if (!renderUsingBackend(data)){
        const top = data.top || data;
        renderFallback(top);
      }
      els.status.textContent='完成'; setTimeout(()=> setProgress(0), 900);
    }catch(err){
      console.error(err);
      els.resultLine.innerHTML = `輸出：<span class="small">${(err && err.message) || '推論發生錯誤'}</span>`;
      els.status.textContent='失敗'; setProgress(0);
    }
  });
</script>
</body>
</html>
